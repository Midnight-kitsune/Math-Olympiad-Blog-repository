<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpSyQVF76lRNRVemUnGmuGXs8Xi7OZ77w",
    authDomain: "pmopractise.firebaseapp.com",
    projectId: "pmopractise",
    storageBucket: "pmopractise.firebasestorage.app",
    messagingSenderId: "195352280795",
    appId: "1:195352280795:web:fd8f97064b8c7f933bd6fe",
    measurementId: "G-MBPF7J64LD"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);

  const signInBtn = document.getElementById("google-signin-btn");
  const signOutBtn = document.getElementById("google-signout-btn");
  const userInfo = document.getElementById("user-info");

  signInBtn.addEventListener("click", async () => {
    const provider = new GoogleAuthProvider();
    try {
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      userInfo.innerHTML = `Hello, <strong>${user.displayName}</strong>`;
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
    } catch (error) { alert("Sign-in failed: "+error.message); }
  });

  signOutBtn.addEventListener("click", async () => {
    await signOut(auth);
    userInfo.innerHTML = "";
    signInBtn.style.display = "inline-block";
    signOutBtn.style.display = "none";
  });

  onAuthStateChanged(auth, (user) => {
    if(user){
      userInfo.innerHTML = `Hello, <strong>${user.displayName}</strong>`;
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";
    } else {
      userInfo.innerHTML = "";
      signInBtn.style.display = "inline-block";
      signOutBtn.style.display = "none";
    }
  });

  // Questions
  const categories = {
    'NT': [
      {q:"The acute angles of a right triangle are a and b, where a>b and both a and b are prime numbers. What is the least possible value of b?", a:["7","seven"], hint:"What happens if b=1,2,3,4?"},
      {q:"A palindrome is a number that reads the same left to right or right to left. A palindrome between 1000 and 10,000 is chosen at random. What is the probability that it is divisible by 7?", a:["1/5"], hint:"Rewrite as 1001a + 110b."},
      {q:"The base-nine representation of the number N is 27,006,000,052_(nine). What is the remainder when N is divided by 5?", a:["3"], hint:"Convert to base 10."}
    ],
    'Combi': [
      {q:"How many ways are there to rearrange the letters of the word SYNONYMS?", a:["5040","7!"], hint:"Use factorial formula."},
      {q:"How many four-digit positive integers have at least one digit that is a 2 or a 3?", a:["5416"], hint:"Complementary counting."},
      {q:"Find the number of subsets of {1,2,3,4,5,6,7,8} that are subsets of neither {1,2,3,4,5} nor {4,5,6,7,8}.", a:["196"], hint:"Complementary counting."}
    ],
    'Geo': [
      {q:"Let ‚ñ≥ABC be isosceles with BC=AC and ‚à†ACB=40¬∞. Construct the circle with diameter BC, and let D,E be intersections with AC and AB. F is intersection of diagonals of BCDE. Degree measure of ‚à†BFC?", a:["110"], hint:"Draw diagram."}
    ],
    'Alg': [
      {q:"Let P(x) = x¬≥ + x¬≤ - 2x + 2020 be polynomial with roots r,s,t. What is P(1)?", a:["-4038","(-4038)"], hint:"Use Vieta's theorem."}
    ]
  };
  categories['Mixed'] = [].concat(categories['NT'], categories['Combi'], categories['Geo'], categories['Alg']);

  let currentCategory = '';
  let availableQuestions = [];
  let currentQuestionIndex = -1;

  function saveProgress() {
    const progressKey = `pmo_progress_${currentCategory}`;
    const doneQuestions = categories[currentCategory].filter(q => !availableQuestions.includes(q));
    localStorage.setItem(progressKey, JSON.stringify(doneQuestions));
  }

  function loadProgress(cat) {
    const progressKey = `pmo_progress_${cat}`;
    const doneQuestions = JSON.parse(localStorage.getItem(progressKey)) || [];
    // FIX: Use filtering by index, not object reference
    return categories[cat].filter(q => !doneQuestions.some(dq => dq.q === q.q));
  }

  window.selectCategory = function(cat){
    currentCategory = cat;
    availableQuestions = loadProgress(cat);
    if (availableQuestions.length === 0) {
      availableQuestions = [...categories[cat]];
    }
    currentQuestionIndex = -1;
    document.getElementById('categories').style.display = 'none';
    document.getElementById('back-btn').style.display = 'block';
    document.getElementById('redo-btn').style.display = 'inline-block';
    nextQuestion();
  }

  window.redoCategory = function(){
    localStorage.removeItem(`pmo_progress_${currentCategory}`);
    availableQuestions = [...categories[currentCategory]];
    nextQuestion();
  }

  window.goBack = function(){
    document.getElementById('question-container').style.display='none';
    document.getElementById('back-btn').style.display='none';
    document.getElementById('redo-btn').style.display='none';
    document.getElementById('categories').style.display='block';
    document.getElementById('feedback').innerText='';
    document.getElementById('hint').style.display='none';
  }

  function nextQuestion(){
    if(availableQuestions.length===0){
      document.getElementById('question-container').style.display='block';
      document.getElementById('question-text').innerText="All questions in this category are finished.";
      document.getElementById('answer-section').style.display='none';
      document.getElementById('hint').style.display='none';
      return;
    }
    currentQuestionIndex = Math.floor(Math.random()*availableQuestions.length);
    const qObj = availableQuestions[currentQuestionIndex];
    document.getElementById('question-container').style.display='block';
    document.getElementById('question-text').innerText = qObj.q;
    document.getElementById('user-answer').value='';
    document.getElementById('feedback').innerText='';
    document.getElementById('hint').style.display='none';
    document.getElementById('answer-section').style.display='flex';
  }

  window.checkAnswer = function(){
    const userAns = document.getElementById('user-answer').value.trim().toLowerCase();
    const qObj = availableQuestions[currentQuestionIndex];
    if(qObj.a.some(a=>a.toLowerCase()===userAns)){
      document.getElementById('feedback').innerText="‚úÖ Correct!";
      availableQuestions.splice(currentQuestionIndex,1);
      saveProgress();
      setTimeout(nextQuestion,3000);
    } else {
      document.getElementById('feedback').innerText="‚ùå Try again!";
    }
  }

  window.showHint = function(){
    const qObj = availableQuestions[currentQuestionIndex];
    document.getElementById('hint').innerText="üí° Hint: "+qObj.hint;
    document.getElementById('hint').style.display='block';
  }

  window.skipQuestion = function(){
    nextQuestion();
  }
</script>
